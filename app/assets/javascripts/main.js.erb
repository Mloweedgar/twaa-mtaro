$(function() {

  //var center = new L.LatLng(-6.7992, 39.2428);
  var center = new L.LatLng(-6.817523270254579, 39.25610303878784);
  var mapOptions = {
    center: center,
    zoom: 14,
    doubleClickZoom:true
  }

  //kml layer with drains 
  var kmlLayer;
 
  /* Creating map*/
  var map = new L.Map('map_canvas',mapOptions);
  var osm = new L.TileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
  map.addLayer(osm);

  /* load KML data when zoomed */
  
  var refreshKML = function () {

    /* Styling mitaro */
    var customLayer= L.geoJson(null, {
        style: function(feature) {
            switch (feature.properties.styleUrl) {
                case '#unclear': return {color: "#dd9031"};
                case '#adopted': return {color:"blue"};
                case '#needs_help': return {color:"#de6060"};
                case '#cleared': return {color:"green"};

            }
        }
    });
    if(kmlLayer){
      map.removeLayer(kmlLayer);
    }
    

    /* dyamically loading mitaro using the center coordinates */
    var c = map.getCenter();
    console.info("Rendering sidewalks of [%s, %s]", c.lat, c.lng);
    var url = 'sidewalks.kml?lat=' + c.lat + '&lng=' + c.lng + '&r=' + (new Date()).valueOf();

    /* Loading KML*/
    kmlLayer = omnivore.kml(url, null, customLayer).addTo(map);

    /* Listens to clicks on drains*/
    kmlLayer.on('click', function (e) {

        var mtaro = e.layer.feature.properties;
        // Fetching drain info 
        fetchDrainInfo(mtaro.description, e.latlng);
    });

    /*add KML layer to map*/
    map.addLayer(kmlLayer);
  }
  refreshKML();


  /* popup Window for displaying details of Mtaro */
  function createPopup(msg, pos){
    if (pos == null){
      pos = map.getCenter();
    }
    var popup = L.popup({maxWidth : 960})
                .setLatLng(pos)
                .setContent(msg)
                .openOn(map);
    bind(pos);
  }

  function fetchDrainInfo(gid, pos) {

    if (gid == undefined) {
      // do nothing
      return false;
    }
    var dataToReturn;
    //if (bDebug) console.info(e.latLng);
    $.ajax({
      type: 'GET',
      url: '/sidewalk_claims/' + gid,
      data: {
        //'id': activeObjectId
      },
      error: function(jqXHR) {
      },
      success: function(data) {
        //renderSocialButtons();
        createPopup(data, pos);
      }
    });

  }

  function showSpinner() {
    $('#spinner').show();
  }
  
  function hideSpinner() {
    $('#spinner').hide();
  }

function bind(pos){

  $('#clean').on('click', function() {
    var id = $(this).attr('data-moid');

    $.ajax({
      type: 'POST',
      url: '/sidewalks/' + id,
      data: { 'moid': $(this).attr('data-moid'),
              'authenticity_token': AUTH_TOKEN,
              '_method': 'put',
              'shoveled': true },
      error: function(jqXHR) {
        data = $.parseJSON(jqXHR.responseText);
        if (bDebug) console.error(data);
      },
      success: function(data) {
        refreshKML();
        createPopup(data, pos);
      }
    });
    return false;
  });

  $('#unclean').on('click', function() {
    var id = $(this).attr('data-moid');

    $.ajax({
      type: 'POST',
      url: '/sidewalks/' + id,
      data: { 'moid': $(this).attr('data-moid'),
              'authenticity_token': AUTH_TOKEN,
              '_method': 'put',
              'shoveled': false },
      error: function(jqXHR) {
        data = $.parseJSON(jqXHR.responseText);
        if (bDebug) console.error(data);
      },
      success: function(data) {
        refreshKML();
        createPopup(data, pos);
      }
    });
    return false;
  });

}

});
